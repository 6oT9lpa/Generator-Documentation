

## Part 1
# Документация для файла `env.py`

## Содержание
- [Назначение файла](#назначение-файла)
- [Импортируемые зависимости](#импортируемые-зависимости)
- [Функции](#функции)
  - [run_migrations_offline](#run_migrations_offline)
  - [run_migrations_online](#run_migrations_online)
- [Основная логика выполнения](#основная-логика-выполнения)
- [Используемые библиотеки](#используемые-библиотеки)

## Назначение файла
Файл `env.py` является частью системы миграций `Alembic` и отвечает за:
- Настройку подключения к базе данных
- Определение метаданных моделей SQLAlchemy
- Выполнение миграций в двух режимах: онлайн и оффлайн

## Импортируемые зависимости
```python
from logging.config import fileConfig
from sqlalchemy import engine_from_config
from sqlalchemy import pool
from alembic import context
from __init__ import Base
```

## Функции

### `run_migrations_offline()`
**Сложность:** O(n) - зависит от количества миграций  
**Назначение:** Выполняет миграции в оффлайн-режиме (без постоянного подключения к БД)

**Входные параметры:**
- Нет явных параметров, использует конфигурацию из `alembic.ini`

**Что может вывести:**
- Логи выполнения миграций
- Ошибки подключения к БД
- Ошибки выполнения SQL-запросов

**Описание:**
1. Получает URL подключения из конфигурации
2. Настраивает контекст миграций с указанными параметрами:
   - `url` - строка подключения к БД
   - `target_metadata` - метаданные моделей SQLAlchemy
   - `literal_binds=True` - для корректного логирования SQL-запросов
   - `dialect_opts={"paramstyle": "named"}` - стиль параметров в запросах
3. Запускает миграции в транзакции

**⚠️ Внимание:** В этом режиме некоторые функции БД могут быть недоступны

---

### `run_migrations_online()`
**Сложность:** O(n) - зависит от количества миграций  
**Назначение:** Выполняет миграции в онлайн-режиме (с постоянным подключением к БД)

**Входные параметры:**
- Нет явных параметров, использует конфигурацию из `alembic.ini`

**Что может вывести:**
- Логи выполнения миграций
- Ошибки подключения к БД
- Ошибки выполнения SQL-запросов

**Описание:**
1. Создает подключение к БД с помощью `engine_from_config`
2. Использует `NullPool` для управления соединениями
3. Настраивает контекст миграций с активным подключением
4. Запускает миграции в транзакции

**❗ Осторожно:** При ошибках во время миграции возможен откат транзакции

## Основная логика выполнения
```python
if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```
Определяет режим выполнения миграций на основе конфигурации Alembic

## Используемые библиотеки
- [Alembic](https://alembic.sqlalchemy.org/) (Python) - система миграций для SQLAlchemy
- [SQLAlchemy](https://www.sqlalchemy.org/) (Python) - ORM для работы с базами данных
- `logging.config` (Python) - настройка системы логирования